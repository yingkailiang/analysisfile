"use strict";const Chrome=require("chrome");const Cc=Chrome.Cc,Ci=Chrome.Ci;const Logger=require("utils-sf/logger").Logger;const memory=require("api-utils/memory");const URL=require("api-utils/url");var requests=[];const TERMINATE_EVENTS=["load","error","abort"];const READ_ONLY_PROPS=["readyState","responseText","status","statusText","withCredentials","response"];const PROPS=["responseType","onreadystatechange"].concat(TERMINATE_EVENTS.map(function(a){return"on"+a}));const DELEGATED_METHODS=["abort","getAllResponseHeaders","getResponseHeader","overrideMimeType","send","sendAsBinary","setRequestHeader","open"];var getRequestCount=exports.getRequestCount=function getRequestCount(){return requests.length};const domParser=Cc["@mozilla.org/xmlextras/domparser;1"].createInstance(Ci.nsIDOMParser);const serializer=Cc["@mozilla.org/xmlextras/xmlserializer;1"].createInstance(Ci.nsIDOMSerializer);exports.inject=function(d,c,b){const a=function(i){i.__exposedProps__={prototype:"r"};i.prototype={_init:function(){var l=Cc["@mozilla.org/xmlextras/xmlhttprequest;1"].createInstance(Ci.nsIXMLHttpRequest);l.mozBackgroundRequest=true;memory.track(l,"XMLHttpRequest");this._req=l;this._orsc=null;requests.push(this);var k=this;this._boundCleanup=function j(){k._cleanup()};TERMINATE_EVENTS.forEach(function(n){k._req.addEventListener(n,k._boundCleanup,false)});var m={};READ_ONLY_PROPS.concat(DELEGATED_METHODS).concat(["responseXML"]).forEach(function(n){m[n]="r"});PROPS.forEach(function(n){m[n]="rw"});this.__exposedProps__=m},_cleanup:function e(){this.onreadystatechange=null;var k=requests.indexOf(this);if(k!=-1){var j=this;TERMINATE_EVENTS.forEach(function(l){j._req.removeEventListener(l,j._boundCleanup,false)});requests.splice(k,1)}},_unload:function f(){this._req.abort();this._cleanup()},addEventListener:function h(){this._req.addEventListener.apply(this._req,arguments)},removeEventListener:function g(){this._req.removeEventListener.apply(this._req,arguments)},set upload(j){throw new Error("not implemented")},get onreadystatechange(){return null;return this._orsc},set onload(j){if(typeof j=="function"){this._req.addEventListener("load",j,false)}},set onerror(j){if(typeof j=="function"){this._req.addEventListener("error",j,false)}},set onreadystatechange(j){this._orsc=j;if(j){var k=this;this._req.onreadystatechange=function(){k._orsc.call(k)}}else{this._req.onreadystatechange=null}},set responseType(j){this._req.responseType=j},get responseType(){return this._req.responseType},open:function(){arguments[1]=URL.URL(arguments[1],b.location.href);return this._req.open.apply(this._req,arguments)}};READ_ONLY_PROPS.forEach(function(j){i.prototype.__defineGetter__(j,function(){return this._req[j]})});i.prototype.__defineGetter__("responseXML",function(){try{return this._req.responseXML&&(this._req.responseXML.wrappedJSObject||b.DOMParser().parseFromString(serializer.serializeToString(this._req.responseXML),"text/xml"))}catch(j){return null}});DELEGATED_METHODS.forEach(function(j){i.prototype[j]=i.prototype[j]||function(){return this._req[j].apply(this._req,arguments)}});return i};require("unload").when(function(){requests.slice().forEach(function(e){e._unload()})});b.XMLHttpRequestFactory=a;b.XMLHttpRequest=a(function(){this._init()})};