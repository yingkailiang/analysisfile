"use strict";const Logger=require("utils-sf/logger").Logger;const Trait=require("traits").Trait;const Services=require("utils-sf/services");const Ci=require("chrome").Ci;const WEBSTORAGE_PATH="storage";const COMMIT_TIMEOUT=1000;var DatabaseCache={};function escapeFilename(a){return a.replace(/[^\w]+/g,"_")}exports.inject=function(c,b,a){a.openDatabase=(function(i){const h=Trait.compose({message:"",code:0,CONSTRAINT_ERR:6,DATABASE_ERR:1,QUOTA_ERR:4,SYNTAX_ERR:5,TIMEOUT_ERR:7,TOO_LARGE_ERR:3,UNKNOWN_ERR:0,VERSION_ERR:2,constructor:function h(){var j=this;if(typeof data=="object"){["message","code"].forEach(function(k){if(k in data){j[k]=data[k]}})}}});function d(){}d.prototype=new Array;d.prototype.item=function(j){var k=this[j];k.__exposedProps__=Object.keys(k).reduce(function(l,m){l[m]="r";return l},{});return k};const f=Trait.compose({constructor:function f(j){var k=this;if(typeof j=="object"){["insertId","rowsAffected","rows"].forEach(function(l){if(l in j){k[l]=j[l]}})}this.rows=new d();this.rows.__exposedProps__={item:"r",length:"r"}},insertId:null,rowsAffected:0,rows:null});const e=Trait.compose({_databaseName:null,constructor:function e(j){this._databaseName=j},executeSql:function(l,n,q,p){try{var t=DatabaseCache[this._databaseName];if(!t.transactionInProgress){t.beginTransactionAs(t.TRANSACTION_DEFERED);b.setTimeout(function(){if(t.transactionInProgress){t.commitTransaction()}},COMMIT_TIMEOUT)}var k=this;var r;r=t.createStatement(l);if(n){n.forEach(function(v,u){r.bindByIndex(u,v)})}var s=[];if(/^\s*select/i.test(l)){for(var o=0,j=r.columnCount;o<j;o++){s.push(r.getColumnName(o))}}r.executeAsync({results:f(),handled:false,handleResult:function(v){for(var x=v.getNextRow();x;x=v.getNextRow()){var w={};for(var u=0;u<x.numEntries;u++){w[s[u]]=x.getResultByIndex(u)}this.results.rows.push(w)}},handleError:function(u){if(typeof p=="function"){p(k,h(u))}},handleCompletion:function(u){if(u!=Ci.mozIStorageStatementCallback.REASON_FINISHED){if(typeof p=="function"){p(k,h({message:"Query canceled or aborted"}))}}else{this.results.insertId=t.lastInsertRowID;if(typeof q=="function"){this.results.__exposedProps__=Object.keys(this.results).reduce(function(v,w){v[w]="r";return v},{});q(k,this.results)}}}})}catch(m){Logger.error(new Error((t?t.lastErrorString:"database is undefined")+' in "'+l+'"'));if(typeof p=="function"){p(k,h(t.lastErrorString+' in "'+l+'"'))}}}});const g=Trait.compose({_databaseName:null,constructor:function g(j){this._databaseName=j},transaction:function(k){var j=e(this._databaseName);j.__exposedProps__={executeSql:"r"};k(j)}});return function(n,m,k,j){function l(){var p=[[escapeFilename(i.id),escapeFilename(n)].join("-"),"sqlite"].join(".");var q=Services.dirsvc.get("ProfD",Ci.nsIFile);q.append(WEBSTORAGE_PATH);if(!q.exists()||!q.isDirectory()){q.create(Ci.nsIFile.DIRECTORY_TYPE,parseInt("00700",8))}q.append(p);var r=Services.storage.openDatabase(q);return r}if(!(n in DatabaseCache)){DatabaseCache[n]=l();b.addEventListener("unload",(function(p){return function(){DatabaseCache[p].asyncClose();delete (DatabaseCache[p])}})(n),false)}var o=g(n);o.__exposedProps__={transaction:"r"};return o}})(c)};