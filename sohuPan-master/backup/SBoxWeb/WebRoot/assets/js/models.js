Sbox.Models.File=Backbone.Model.extend({update:function(a){var b=this.get("parentDir")||"root",c=this.get("shareFlag"),e="undefined"!==typeof this.get("parentDir")?"dir":"file",g=this.get("id"),f=this;this.isRenaming||(this.isNew()?(this.isRenaming=!0,$.post("/CreateDir!createDir.action",{tagertId:b,name:a,shareFlag:this.get("power")?1:c},function(a){f.isRenaming=!1;701===a.code||403===a.code?Sbox.Login():500===a.code?Sbox.Error({message:"\u6587\u4ef6\u5939\u5df2\u5b58\u5728",callback:function(){f.set({name:""},
{silent:!0});f.trigger("add.fail")}}):a.code?Sbox.Error({message:"\u521b\u5efa\u5931\u8d25",callback:function(){f.set({name:""},{silent:!0});f.trigger("add.fail")}}):(f.set(a),f.trigger("add.success"))},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})):(this.isRenaming=!0,$.post("/RenameResource!rename.action",{id:g,rename:a,type:e},function(b){f.isRenaming=!1;701===b.code||403===b.code?Sbox.Login():200===b.code?(f.set({name:a}),
f.trigger("rename.success")):601===b.code?Sbox.Error({message:"\u6587\u4ef6\u540d\u975e\u6cd5",onHide:function(){f.trigger("rename.fail")}}):Sbox.Error({message:"\u91cd\u547d\u540d\u5931\u8d25",onHide:function(){f.trigger("rename.fail")}})},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})))},updateRemark:function(a){this.get("parentDir");this.get("note");var b="undefined"!==typeof this.get("parentDir")?"dir":"file",
c=this.get("id"),e=this;this.remarking||(this.remarking=!0,$.post("/UpdateResource!update.action",{id:c,note:a,type:b},function(b){e.remarking=!1;701===b.code||403===b.code?Sbox.Login():200===b.code?(e.set({note:a}),e.trigger("remark.success")):Sbox.Error({message:b.message,callback:function(){e.trigger("remark.fail")}})},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}))},setsize:function(a){var b=this.get("parentDir")?
"dir":"file",c=this.get("id"),e=this;$.post("/UpdateResource!update.action",{id:c,dirSize:a,type:b},function(b){e.trigger("setsize.end",b,a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},lock:function(a){this.trigger("lock.begin");var b=this.get("id"),c=this;$.post("/LockFile!lock.action",{resourceId:b,LockTime:a||""},function(a){c.trigger("lock.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},
unlock:function(){this.trigger("unlock.begin");var a=this.get("id"),b=this;$.post("/UnLockFile!unLock.action",{resourceId:a},function(a){b.trigger("unlock.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},getOutChain:function(){if(this.get("hasOutChain")&&this.get("outlink"))this.trigger("getoutchain.end");else{this.trigger("getoutchain.begin");var a=this;$.get("/OutLink!get.action?id="+this.get("id")+"&shareType="+
(this.get("parentDir")?1:0)+"&_t="+Math.random(),function(b){a.trigger("getoutchain.end",b)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})}},editOutChain:function(){if(this.get("hasOutChain")&&this.get("outlink"))this.trigger("beforeedit");else{var a=this;Sbox.Loading("\u6b63\u5728\u83b7\u53d6\u5916\u94fe\u4fe1\u606f...");$.get("/OutLink!get.action?id="+this.get("id")+"&shareType="+(this.get("parentDir")?1:0)+"&_t="+
Math.random(),function(b){Sbox.Loading().remove();a.trigger("beforeedit",b)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})}},createOutChain:function(a,b,c,e,g,f){var h=this;if("undefined"===typeof a){needpass=0;var b="",d=new Date,d=d.valueOf()+2592E6,d=new Date(d),c=d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate()+" 00:00:00",e=""}this.get("outlink")?(this.trigger("editoutchain.begin"),$.post("/OutLink!update.action",
{id:this.get("id"),needpass:a,password:b,expiredate:c,note:e,shareType:this.get("parentDir")?1:0,sharePrivilege:g,language:f},function(d){h.trigger("editoutchain.end",d,a,b,c,e,g,f)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})):(this.trigger("createoutchain.begin"),$.post("/OutLink!create.action",{id:this.get("id"),password:b,expiredate:c,note:e,shareType:this.get("parentDir")?1:0,sharePrivilege:g,language:f},
function(d){h.trigger("createoutchain.end",d,a,b,c,e,g,f)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}))},sendOutChain:function(a,b){this.trigger("sendoutchain.begin");var c=this,e=[];_(a).each(function(a){e.push($.trim(a))});$.post("SendEmail!send.action",{id:this.get("id"),email:e.join(";"),body:b,shareType:this.get("parentDir")?1:0},function(a){c.trigger("sendoutchain.end",a)},"json").error(function(){Sbox.Loading().remove();
Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},createUploadLink:function(a){var b=this;this.get("uploadlink")?(this.trigger("edituploadlink.begin"),$.post("/OutLink!update.action",{id:this.get("id"),password:a.password,expiredate:a.time,shareType:2},function(c){b.trigger("edituploadlink.end",c,a.password,a.time)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})):(this.trigger("createuploadlink.begin"),
$.post("/OutLink!create.action",{id:this.get("id"),password:a.password,expiredate:a.time,shareType:2},function(c){b.trigger("createuploadlink.end",c,a.password,a.time)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")}))},editUploadLink:function(){if(this.get("anonymousUpload")&&this.get("uploadlink"))this.trigger("edituploadlink.before");else{var a=this;Sbox.Loading("\u6b63\u5728\u83b7\u53d6\u533f\u540d\u4e0a\u4f20\u94fe\u63a5\u4fe1\u606f...");
$.get("/OutLink!get.action?id="+this.get("id")+"&shareType=2&_t="+Math.random(),function(b){Sbox.Loading().remove();a.trigger("edituploadlink.before",b)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})}},getUploadLink:function(){if(this.get("anonymousUpload")&&this.get("uploadlink"))this.trigger("getuploadlink.end");else{this.trigger("getuploadlink.begin");var a=this;$.get("/OutLink!get.action?id="+this.get("id")+
"&shareType=2&_t="+Math.random(),function(b){a.trigger("getuploadlink.end",b)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})}}});Sbox.Models.Pager=Backbone.Model.extend({defaults:{curpage:1,total:1E3,pagesize:20,middleCount:5},getPapeCount:function(){return Math.ceil(this.get("total")/this.get("pagesize"))}});
Sbox.Models.Path=Backbone.Model.extend({defaults:{path:"/",pathId:"root",upload:!0,create:!0},initialize:function(){this.cache={};this.cache["/"+MY_DISK_NAME]=!0;this.cache["/"+SHARE_DISK_NAME]=!0},addCache:function(a){var b=this.cache;_(a).each(function(a){do b[a]=!0,a=a.substring(0,a.lastIndexOf("/"));while(a)})},delCache:function(a){var b=this.cache;_(b).each(function(c,e){0===e.indexOf(a)&&delete b[e]})}});Sbox.Models.linkPath=Backbone.Model.extend({defaults:{path:"",pathId:"",pathIds:""},initialize:function(){}});
Sbox.Models.ToolBar=Backbone.Model.extend({defaults:{selectedFiles:[]},initialize:function(){this.reset()},setSelectedFiles:function(a){this.set({selectedFiles:a},{silent:!0});this.reset();if(0!==a.length){if(1===a.length){var b=a[0].get("email"),c=a[0].get("parentDir"),e=c==userId||"root"===c,g=!b&&getFileType(a[0].get("name")),f=previewFileType.test(g),h=a[0].get("shareFlag"),d=a[0].get("power"),i=a[0].get("isShareFile");if("rar"===g||"zip"===g)104857600<1*a[0].get("size")&&(f=!1);b||(c?a[0].get("acl")?
(this.set({quitshare:"p"===a[0].get("type"),showmember:!0}),(1===a[0].get("acl")||2===a[0].get("acl")||3===a[0].get("acl"))&&this.set({download:!0,outchain:!0,hasOutChain:a[0].get("hasOutChain")})):(d||this.set({uploadlink:!0,anonymousUpload:a[0].get("anonymousUpload")}),!d||2===d&&a[0].get("creatorId")===userId||3===d?this.set({upload:!0,download:!0,outchain:!0,hasOutChain:a[0].get("hasOutChain"),share:e,remark:!0,move:i||h?!1:!0,rename:!0,del:!0,size:h,hasShare:h}):4===d||(5===d||6===d)||this.set({download:!0,
outchain:!0,hasOutChain:a[0].get("hasOutChain")})):!d||2===d&&a[0].get("creatorId")===userId||3===d?this.set({preview:f,download:!0,outchain:!0,remark:!0,move:i?!1:!0,rename:!0,del:!0,history:!0,hasOutChain:a[0].get("hasOutChain")}):4===d||6===d?this.set({preview:f}):(2===d||1===d)&&this.set({preview:f,download:!0,outchain:!0,hasOutChain:a[0].get("hasOutChain")}))}else{var b=a[0].get("email"),l=!0,k=!0,m=!1,d=a[0].get("power"),i=a[0].get("isShareFile"),j=null;_(a).each(function(b){"undefined"!==typeof b.get("parentDir")&&
(l=!1,j||(j=b));a[0].get("power")&&!(2===a[0].get("power")&&b.get("creatorId")===userId)&&(k=!1);b.get("shareFlag")&&(m=!0)});b||(l?k||3===d?this.set({download:!0,move:i?!1:!0,del:!0}):6===d||(5===d||4===d)||(2===d||1===d)&&this.set({download:!0}):j.get("acl")?3>=j.get("acl")&&this.set({download:!0}):k||3===d?this.set({download:!0,move:i||m?!1:!0,del:!0}):4<=d||(1===d||2===d)&&this.set({download:!0}))}this.trigger("change")}},reset:function(){this.set({upload:!1,quitshare:!1,showmember:!1,preview:!1,
download:!1,share:!1,outchain:!1,uploadlink:!1,remark:!1,move:!1,copy:!1,rename:!1,del:!1,history:!1,lock:!1,unlock:!1,size:!1,hasShare:!1,hasOutChain:!1,anonymousUpload:!1},{silent:!0})}});Sbox.Models.ContextMenu=Sbox.Models.ToolBar.extend({});
Sbox.Models.LinkToolbar=Backbone.Model.extend({defaults:{selectedFiles:[]},initialize:function(){this.reset()},setSelectedOutChains:function(a){this.set({selectedFiles:a},{silent:!0});this.reset();0!==a.length&&(1===a.length?this.set({send:!0,copy:!0,edit:!0,del:!0}):this.set({del:!0}),this.trigger("change"))},reset:function(){this.set({send:!1,copy:!1,edit:!1,del:!1},{silent:!0})}});Sbox.Models.LinkContextMenu=Sbox.Models.LinkToolbar.extend({});
Sbox.Models.UploadLinkToolbar=Backbone.Model.extend({defaults:{selectedFiles:[]},initialize:function(){this.reset()},setSelectedUploadLinks:function(a){this.set({selectedFiles:a},{silent:!0});this.reset();0!==a.length&&(1===a.length?this.set({copy:!0,edit:!0,del:!0}):this.set({del:!0}),this.trigger("change"))},reset:function(){this.set({copy:!1,edit:!1,del:!1},{silent:!0})}});Sbox.Models.UploadLinkContextMenu=Sbox.Models.UploadLinkToolbar.extend({});
Sbox.Models.RecycleToolbar=Backbone.Model.extend({defaults:{selectedFiles:[]},initialize:function(){this.reset()},setSelectedOutChains:function(a){this.set({selectedFiles:a},{silent:!0});this.reset();0!==a.length&&(1<=a.length&&this.set({reduce:!0,del:!0}),this.trigger("change"))},reset:function(){this.set({reduce:!1,del:!1},{silent:!0})}});Sbox.Models.RecycleContextMenu=Sbox.Models.RecycleToolbar.extend({});
Sbox.Collections.FileList=Backbone.Collection.extend({model:Sbox.Models.File,initialize:function(a,b){var c=b.type;"mine"===c?this.url="/GetNodeList!getService.action":"public"===c?this.url="/GetPublicNodeList!getService.action":"share"===c?this.url="/GetShareDir!getNodes.action":"outchain"===c?this.url="/OutLink!getAll.action":"uploadlink"===c?this.url="/OutLink!getAnonymousAll.action":"recyclebin"===c?this.url="/Trash!get.action":"outlink"===c&&(this.url="/GetDirAndFile!getService.action")},getChecked:function(){var a=
[];this.each(function(b){b.get("checked")&&a.push(b)});return a},checkAll:function(){this.each(function(a){a.isNew()||a.set({checked:!0})})},uncheckAll:function(){this.each(function(a){a.isNew()||a.set({checked:!1})})},checkById:function(a){this.get(a).set({checked:!0})},uncheckById:function(a){this.get(a).set({checked:!1})},toggelCheckById:function(a){this.get(a).get("checked")?this.uncheckById(a):this.checkById(a)},getIndexOfById:function(a){a=this.get(a);return this.indexOf(a)},getFoldNum:function(){var a=
0;this.each(function(b){b.isNew()||("undefined"!==typeof b.get("parentDir")||"undefined"!==typeof b.get("email"))&&a++});return a},getFileNum:function(){return this.length-this.getFoldNum()},getIds:function(a){var b=[],c=[];_(a).each(function(a){"undefined"!==typeof a.get("parentDir")?b.push(a.get("id")):c.push(a.get("id"))});return{dirIds:b,fileIds:c}},deleteFiles:function(a){var b=this;this.trigger("delete.start");a=this.getIds(a);$.post("/DeleteObject!delete.action",{dirIds:a.dirIds.join(","),
fileIds:a.fileIds.join(",")},function(a){b.trigger("delete.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},moveFiles:function(a,b,c,e){var g=this;e?(url="/MoveRestoreResource!move.action",this.trigger("restore.begin")):b?(url="/CopyResource!copy.action",this.trigger("copy.start")):(url="/MoveResource!move.action",this.trigger("move.start"));a=this.getIds(a);$.post(url,{targetId:c,dirIds:a.dirIds.join(","),
fileIds:a.fileIds.join(",")},function(a){e?g.trigger("restore.end",a,c):b?g.trigger("copy.end",a,c):g.trigger("move.end",a,c)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},deleteOutchains:function(a){var b=this;this.trigger("deleteoutchain.begin");a=this.getIds(a);$.post("/OutLink!delete.action",{dirIds:a.dirIds.join(","),fileIds:a.fileIds.join(",")},function(a){b.trigger("deleteoutchain.end",a)},"json").error(function(){Sbox.Loading().remove();
Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},deleteUploadLinks:function(a){var b=this;this.trigger("deleteuploadlink.begin");var c=this.getIds(a);$.post("/OutLink!delete.action",{dirIds:c.dirIds.join(","),fileIds:c.fileIds.join(","),shareType:a[0].get("anonymousUpload")?2:""},function(a){b.trigger("deleteuploadlink.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},restore:function(a){var b=
this;this.trigger("restore.begin");a=this.getIds(a);$.post("/Trash!regain.action",{dirIds:a.dirIds.join(","),fileIds:a.fileIds.join(",")},function(a){b.trigger("restore.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},completeDelete:function(a){var b=this;this.trigger("completedelete.begin");a=this.getIds(a);$.post("/Trash!delete.action",{dirIds:a.dirIds.join(","),fileIds:a.fileIds.join(",")},function(a){b.trigger("completedelete.end",
a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},empty:function(){var a=this;this.trigger("empty.begin");$.post("/Trash!clear.action",function(b){a.trigger("empty.end",b)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})},quitshare:function(a){var b=this;this.trigger("quit.begin");a=this.getIds(a);$.post("/ShareDir!quit.action",
{dirIds:a.dirIds.join(",")},function(a){b.trigger("quit.end",a)},"json").error(function(){Sbox.Loading().remove();Sbox.Error("\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u5019\u91cd\u8bd5")})}});
