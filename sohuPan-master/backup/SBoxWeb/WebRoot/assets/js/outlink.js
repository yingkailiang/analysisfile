var outlinkLanguage={"ch-zn":{passwordEmpty:"\u8bf7\u8f93\u5165\u5bc6\u7801",passwordError:"\u5bc6\u7801\u9519\u8bef",emptyFile:"\u7a7a\u6587\u4ef6\u4e0d\u652f\u6301\u5728\u7ebf\u9884\u89c8",emptyFolder:"\u8be5\u76ee\u5f55\u4e0b\u8fd8\u6ca1\u6709\u6587\u4ef6\uff01",loading:"\u6b63\u5728\u52a0\u8f7d..."},en:{passwordEmpty:"Enter password",passwordError:"Password incorrect",emptyFile:"Empty file can't preview",emptyFolder:"This folder is empty",loading:"Loading..."}};
outLinkInfo.language=0==outLinkInfo.language?"ch-zn":1==outLinkInfo.language?"en":"ch-zn";
Sbox.Views.OutLinkPathView=Backbone.View.extend({className:"navigation",template:_.template($("#navigation-template").html()),events:{"click .up a":"goback","click .path a":"gopath"},initialize:function(){_.bindAll(this,"render");this.model.bind("change",this.render);this.model.bind("path.load",this.render)},render:function(){var a=this.model.get("path"),b=this.model.get("pathIds");this.path=a=a.split("/").slice(1);this.pathIds=b;this.$el.html(this.template({paths:a,pathIds:b}));return this},goback:function(a){$(a.currentTarget).hasClass("disabled")||
(this.gopath(this.path.length-1),a.preventDefault())},gopath:function(a){var b;$.isNumeric(a)?b=a-1:(b=parseInt($(a.currentTarget).attr("_index")),a.preventDefault());this.path=this.path.slice(0,b+1);this.pathIds=this.pathIds.slice(0,b+1);this.model.set({path:"/"+this.path.join("/"),pathId:this.pathIds[b],pathIds:this.pathIds});this.model.trigger("path.load")}});
Sbox.Views.OutLinkFileSortView=Backbone.View.extend({className:"list-header",template:_.template($("#file-sort-template").html()),events:{"click .checkbox":"checkAll","click .name":"sortByName","click .size":"sortBySize","click .create-time":"sortByCreateTime","click .time":"sortByTime"},initialize:function(){this.fileList=this.options.fileList;this.path=this.options.path;_.bindAll(this,"render","toggleChecked","cancelSort");this.fileList.bind("change",this.toggleChecked);this.fileList.bind("reset",
this.toggleChecked);this.fileList.bind("path.load",this.cancelSort)},render:function(){this.$el.html(this.template({path:!0}));return this},toggleChecked:function(){var a=this.fileList.getChecked();0===this.fileList.length||a.length!==this.fileList.length?this.$el.find(".checkbox .icon").removeClass("icon-checked").addClass("icon-unchecked"):this.$el.find(".checkbox .icon").removeClass("icon-unchecked").addClass("icon-checked")},cancelSort:function(){this.$(".col").removeClass("asc").removeClass("desc")},
checkAll:function(a){$(a.currentTarget).find("span").hasClass("icon-unchecked")?this.fileList.checkAll():this.fileList.uncheckAll()},sortByName:function(a){this.$el.find(".size,.time,.create-time").removeClass("asc").removeClass("desc");this.sortBy(a,"name")},sortBySize:function(a){this.$el.find(".name,.time,.create-time").removeClass("asc").removeClass("desc");this.sortBy(a,"size")},sortByTime:function(a){this.$el.find(".name,.size,.create-time").removeClass("asc").removeClass("desc");this.sortBy(a,
"modifyTime")},sortByCreateTime:function(a){this.$el.find(".name,.size,.time").removeClass("asc").removeClass("desc");this.sortBy(a,"createTime")},sortBy:function(a,b){var c=$(a.currentTarget),f=c.hasClass("asc"),d=this.fileList.groupBy(function(a){return"undefined"!==typeof a.get("parentDir")?1:0}),e;for(e in d)"size"===b&&"1"===e||("name"===b?this.fileList.models[0].get(b)?d[e].sort(function(a,c){return(f?1:-1)*a.get(b).localeCompare(c.get(b))}):d[e].sort(function(a,b){return(f?1:-1)*a.get("nickName").localeCompare(b.get("nickName"))}):
"size"===b?d[e].sort(function(a,c){return(f?1:-1)*(a.get(b)-c.get(b))}):("modifyTime"===b||"createTime"===b)&&d[e].sort(function(a,c){var d=a.get(b).split(" "),e=c.get(b).split(" "),d=d[0].split("-").concat(d[1].split(":")),e=e[0].split("-").concat(e[1].split(":"));d[1]--;e[1]--;return(f?1:-1)*(new Date(d[0],d[1],d[2],d[3],d[4],d[5])-new Date(e[0],e[1],e[2],e[3],e[4],e[5]))}));f?c.removeClass("asc").addClass("desc"):c.removeClass("desc").addClass("asc");this.fileList.models=[].concat(d["1"]||[],d["0"]||
[]);this.fileList.trigger("reset")}});
Sbox.Views.OutLinkFileListView=Backbone.View.extend({className:"list-body",template:_.template($("#file-list-tempate").html()),events:{"mouseenter li.file":"hover","mouseleave li.file":"leave","click li.file":"check","dblclick li.file":"gotoPath"},initialize:function(){this.currentElement=null;this.showType="listview";this.fileList=this.options.fileList;this.path=this.options.path;_.bindAll(this,"render","addOne","addAll","refresh","loading","changeView");this.fileList.bind("add",this.addOne);this.fileList.bind("reset",
this.addAll);this.fileList.bind("view.change",this.changeView);this.path.bind("path.load",this.refresh);this.fileList.bind("reload",this.refresh);this.fileList.bind("loading",this.loading)},render:function(){var a=this;this.$el.html(this.template({showtype:111}));this.$(".files");this.$(".files").attr("class","files clearfix "+this.showType);this.$el.find("ul.files").mousedown(function(b){if((b.target||b.srcElement)===this)a.currentElement=null,setTimeout(function(){a.fileList.uncheckAll()},20);!$(b.target).is("input")&&
a.$el.find(".active")[0]&&(a.$el.find(".active input").blur(),b.preventDefault(),b.stopImmediatePropagation())});this.$el.find("ul.files").drag("start",function(b){var c=b.target||b.srcElement;if($(c).hasClass("icon")||$(c).is("a")||$(c).hasClass("file-type"))return!1;a.contextMenuElement&&$(a.contextMenuElement.el).hide();if(a.$el.find(".active")[0]||a.isDraggingFile)return!1;a.isDragging=!0;!b.ctrlKey&&!b.shiftKey&&a.fileList.uncheckAll();return $('<div class="selection" />').css("opacity",0.65).appendTo(document.body)}).drag(function(a,
c){$(c.proxy).css({top:Math.min(a.pageY,c.startY),left:Math.min(a.pageX,c.startX),height:Math.abs(a.pageY-c.startY),width:Math.abs(a.pageX-c.startX)})}).drag("end",function(b,c){a.isDragging=!1;$(c.proxy).remove()});$.drop({multi:!0});return this},addOne:function(a){var b=this;1===this.fileList.length&&(this.$(".files").empty(),this.$(".files").attr("class","files clearfix "+this.showType));a.set({power:b.path.get("acl")});a=new Sbox.Views.OutLinkFileItemView({model:a,type:this.showType,fileList:this.fileList,
path:this.path});this.$(".files").prepend(a.render().el);this.path.get("pathId");var c=a.$el.find(".file-name"),f=c.find("input");c.addClass("active");setTimeout(function(){f.focus();f.select()},30);a.$el.drop("start",function(){$(this).addClass("active")}).drop(function(){var a=$(this).attr("_id");b.fileList.toggelCheckById(a)}).drop("end",function(){$(this).removeClass("active")})},addAll:function(){var a=this;this.currentElement=null;if(0<this.fileList.length)if(this.$(".files").attr("class","files clearfix "+
this.showType),this.fileList.at(0).get("code"))Sbox.Login();else{var b=this.path.get("pathId"),c=this.path.get("uid"),f=this.fileList.at(0),d=f.get("email"),e=f.get("parentDir"),f=d?"root":e?e:f.get("belongDir");f!=b&&f!=c||(this.$(".files").empty(),this.fileList.each(function(b){b.set({power:a.path.get("acl")});b=new Sbox.Views.OutLinkFileItemView({model:b,type:a.showType,fileList:a.fileList,path:a.path});a.$(".files").append(b.render().el)}),this.$el.find(".file").drop("start",function(){$(this).addClass("active")}).drop(function(){var b=
$(this).attr("_id");a.fileList.toggelCheckById(b)}).drop("end",function(){$(this).removeClass("active")}),$.drop({multi:!0}))}else this.$(".files").empty(),this.$(".files").attr("class","files"),"share"===this.path.get("type")&&"root"===this.path.get("pathId")?this.$(".files").append($('<li class="not-get-shared">\u60a8\u8fd8\u6ca1\u6709\u6536\u5230\u5171\u4eab\u6587\u4ef6\uff01 </li>')):this.$(".files").append($('<li style="text-align:center; padding:20px 0; color:gray; font-size:16px;">'+outlinkLanguage[outLinkInfo.language].emptyFolder+
" </li>"))},refresh:function(){var a=this.fileList;a.trigger("loading");a.fetch({data:{id:""===this.path.get("pathId")?"root":this.path.get("pathId"),userId:outLinkInfo.userId,date:outLinkInfo.date,sign:outLinkInfo.sign,_t:Math.random()}})},loading:function(){this.$(".files").empty();this.$(".files").attr("class","files");this.$(".files").append($('<li style="text-align:center; padding:20px 0; color:gray;"><span class="icon icon-loading"></span> '+outlinkLanguage[outLinkInfo.language].loading+"</li>"))},
changeView:function(a){this.showType=a;this.fileList.trigger("reset")},hover:function(a){this.isDragging||(a=$(a.currentTarget),a.addClass("hover"),a.hasClass("ismine")&&a.addClass("ismine-hover"))},leave:function(a){a=$(a.currentTarget);a.removeClass("hover");a.hasClass("ismine")&&a.removeClass("ismine-hover");a.find(".more-operation").hide()},check:function(a){var b=$(a.currentTarget),c=b.attr("_id"),f=this.fileList,d=f.get(c);this.$el.find(".list-item");if(d&&(c=a.target||a.srcElement,!$(c).hasClass("icon-checked")&&
!$(c).hasClass("icon-unchecked"))){if(!a.ctrlKey&&!a.shiftKey||null===this.currentElement)this.currentElement=b,!a.ctrlKey&&!a.shiftKey&&(d.get("checked")&&1===f.getChecked().length?setTimeout(function(){d.set({checked:!1})},30):setTimeout(function(){f.uncheckAll();d.set({checked:!0})},30));a.ctrlKey&&d.set({checked:!d.get("checked")});if(a.shiftKey){var e=f.getIndexOfById(this.currentElement.attr("_id")),g=f.getIndexOfById(b.attr("_id"));e>g&&(e+=g,g=e-g,e-=g);f.each(function(a,b){b>=e&&b<=g?f.at(b).set({checked:true}):
f.at(b).set({checked:false})})}}},gotoPath:function(a){if(!$(a.target).is("input")){var a=$(a.currentTarget).attr("_id"),b=this.fileList,c=b.get(a);c&&"undefined"!==typeof c.get("parentDir")&&(b.trigger("loading"),b=this.path.get("path")+"/"+c.get("name"),c=this.path.get("pathIds"),c.push(a),this.path.set({path:b,pathId:a,pathIds:c}),this.path.trigger("path.load"))}}});
Sbox.Views.OutLinkFileItemView=Backbone.View.extend({tagName:"li",className:"file",listTemplate:_.template($("#listview-file-template").html()),events:{"click .checkbox":"check","click .file-name a":"openFile","click .file-icon a":"openFile"},initialize:function(){this.type=this.options.type;this.fileList=this.options.fileList;this.path=this.options.path;_.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){var a=this.type;"listview"===a&&this.$el.html(this.listTemplate(this.model.toJSON()));
this.model.isNew()?this.$el.addClass("isnew"):(this.$el.attr("_id",this.model.id),this.$el.attr("id",this.model.id),this.$el.removeClass("isnew"));this.model.get("power")&&this.$el.addClass("power"+this.model.get("power"));this.model.get("parentDir")||this.$el.addClass("isfile");this.model.get("checked")?this.$el.addClass("selected"):this.$el.removeClass("selected");"listview"===a?this.$el.addClass("list-item"):this.$el.addClass("preview-item");return this},check:function(a){$(a.currentTarget).find(".icon").hasClass("icon-unchecked")?
this.model.set({checked:!0}):this.model.set({checked:!1});this.fileList.trigger("hidecontexmenu");a.stopImmediatePropagation()},openFile:function(a){var b=this;if(this.model.get("parentDir")){setTimeout(function(){b.fileList.trigger("loading")},20);var c=this.path.get("path")+"/"+this.model.get("name"),f=this.path.get("pathIds"),d=this.model.get("id");f.push(d);this.path.set({path:c,pathId:d,pathIds:f},{silent:!0});this.path.trigger("path.load");a.preventDefault();a.stopImmediatePropagation()}else c=
getFileType(this.model.get("name")),isPreviewImgFile(this.model.get("name"),this.model.get("size"))?(Sbox.Preview(this.model,this.fileList),a.preventDefault()):previewFileType.test(c)?0===this.model.get("size")&&(Sbox.Fail(outlinkLanguage[outLinkInfo.language].emptyFile),a.preventDefault()):a.preventDefault()}});
Sbox.Views.OutLinkFileStatView=Backbone.View.extend({className:"file-stat",template:_.template($("#file-stat-template").html()),initialize:function(){this.fileList=this.options.fileList;_.bindAll(this,"render");this.fileList.bind("reset",this.render);this.fileList.bind("restat",this.render)},render:function(){var a=this.fileList.getFoldNum(),b=this.fileList.getFileNum();this.$el.html(this.template({folderNum:a,fileNum:b}));return this}});
Sbox.Views.OutLinkFileManage=Backbone.View.extend({className:"list-table file-manage",initialize:function(){this.fileList=this.options.fileList;this.path=this.options.path},render:function(){var a=new Sbox.Views.OutLinkFileSortView({fileList:this.fileList,path:this.path}),b=new Sbox.Views.OutLinkFileListView({fileList:this.fileList,path:this.path}),c=new Sbox.Views.OutLinkFileStatView({fileList:this.fileList});this.$el.append(a.render().el).append(b.render().el).append(c.render().el);return this}});
Sbox.Views.OutLinkFileView=Backbone.View.extend({className:"outlink-file",initialize:function(){this.fileList=this.options.fileList;this.path=this.options.path;this.render()},render:function(){var a=new Sbox.Views.OutLinkPathView({model:this.path}),b=new Sbox.Views.OutLinkFileManage({fileList:this.fileList,path:this.path});this.$el.append(a.render().el).append(b.render().el).appendTo($("#fileExplorer"));return this}});
Sbox.Controllers.OutLinkRouter=Backbone.Router.extend({initialize:function(){var a=this;$(window).bind("resize",function(){a.resize()});this.outlinkPathModel=new Sbox.Models.linkPath;this.outlinkPathModel.set({path:"/"+outLinkInfo.name,pathId:outLinkInfo.id,pathIds:[outLinkInfo.id]});this.outlinkFileList=new Sbox.Collections.FileList([],{type:"outlink"});this.outlinkFileView=new Sbox.Views.OutLinkFileView({path:this.outlinkPathModel,fileList:this.outlinkFileList});var b=$("#fileAction"),c=b.find(".file-pass input"),
f=b.find(".file-pass .tips"),d=b.find(".file-btn input"),e=this.outlinkFileList,g=this.outlinkPathModel;window.downloadForm||(window.downloadForm=$('<form method="post" action="GetDirFiles!getFiles.action" style="display:none;"> \t\t\t\t<input type="hidden" name="ids" /> \t\t\t\t<input type="hidden" name="firstName" /> \t\t\t\t<input type="hidden" name="resourceId" /> \t\t\t\t<input type="hidden" name="fileId" /> \t\t\t\t<input type="hidden" name="password" /> \t\t\t\t<input type="hidden" name="userId" value="'+
outLinkInfo.userId+'" /> \t\t\t\t<input type="hidden" name="sign" value="'+outLinkInfo.sign+'" /> \t\t\t\t<input type="hidden" name="date" value="'+outLinkInfo.date+'" /> \t\t\t\t<input type="hidden" name="sid" value="'+outLinkInfo.sid+'" /></form>').appendTo($("body")));e.bind("change",function(){e.getChecked().length===0?d.addClass("btn32-disabled"):d.removeClass("btn32-disabled")});e.bind("reset",function(){e.getChecked().length===0?d.addClass("btn32-disabled"):d.removeClass("btn32-disabled")});
if(c[0])c.on("keypress",function(a){a.keyCode===13&&d.trigger("click")});d.on("click",function(){var a=[],b,d=e.getChecked();b=d.length;var i=e.length;if(b!==0){if(b===1&&!d[0].get("parentDir")){downloadForm.find("input").eq(0).val("");downloadForm.find("input").eq(1).val("");downloadForm.find("input").eq(2).val("");downloadForm.find("input").eq(3).val(d[0].get("id"))}else{if(b===i){downloadForm.find("input").eq(0).val("");downloadForm.find("input").eq(1).val("");downloadForm.find("input").eq(2).val(g.get("pathId"))}else{b=
d[0].get("name");_(d).each(function(b){a.push({resourceId:b.get("id"),flag:b.get("parentDir")?1:0})});downloadForm.find("input").eq(0).val(jsonToString(a));downloadForm.find("input").eq(1).val(b);downloadForm.find("input").eq(2).val("")}downloadForm.find("input").eq(3).val("")}if(c[0]){var h=c.val();h===""?f.html('<span class="error">'+outlinkLanguage[outLinkInfo.language].passwordEmpty+"</span>"):$.post("/CheckShareDirPassword!share.action",{password:h,resourceId:outLinkInfo.id,userId:outLinkInfo.userId,
sign:outLinkInfo.sign,date:outLinkInfo.date},function(a){if(a.code===200){f.empty();downloadForm.find("input").eq(4).val(h);downloadForm.submit()}else f.html('<span class="error">'+outlinkLanguage[outLinkInfo.language].passwordError+"</span>")},"json")}else downloadForm.submit()}});this.outlinkFileView.$el.show();this.outlinkPathModel.trigger("path.load");this.resize()},resize:function(){var a=$("#fileExplorer .list-body"),b=$("#fileAction"),c=$(window).height(),f=$("#header").outerHeight(!0),b=b.height();
a.height(c-f-b-250)}});$(document).ready(function(){new Sbox.Controllers.OutLinkRouter});
