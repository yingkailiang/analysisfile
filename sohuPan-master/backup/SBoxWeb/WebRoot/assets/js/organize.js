Sbox.Models.User=Backbone.Model.extend({setAdmin:function(){var a=this;this.trigger("setadmin.begin");$.post("/OrganManage!setOrganAdmin.action",{userId:this.get("id")},function(b){a.trigger("setadmin.end",b)},"json")},cancelAdmin:function(){var a=this;this.trigger("canceladmin.begin");$.post("/OrganManage!cancelOrganAdmin.action",{userId:this.get("id")},function(b){a.trigger("canceladmin.end",b)},"json")},resend:function(){var a=this;this.trigger("resend.begin");$.post("/OrganManage!reSendEmail.action",
{id:this.get("id")},function(b){a.trigger("resend.end",b)},"json")},edit:function(){}});Sbox.Models.Stat=Backbone.Model.extend({defaults:{all:0,used:0}});window.organizeStatModel=new Sbox.Models.Stat;Sbox.Models.Usage=Backbone.Model.extend({defaults:{all:0,used:0}});window.organizeUsageModel=new Sbox.Models.Usage;Sbox.Models.Pager=Backbone.Model.extend({defaults:{curpage:1,total:1E3,pagesize:20,middleCount:9},getPapeCount:function(){return Math.ceil(this.get("total")/this.get("pagesize"))}});
Sbox.Models.Path=Backbone.Model.extend({defaults:{path:"",organIds:"root"},getOrganId:function(){return this.get("organIds").split("/").reverse()[0]}});
Sbox.Models.ToolBar=Backbone.Model.extend({defaults:{selectedUsers:[]},initialize:function(){this.reset()},setSelectedUsers:function(a){this.set({selectedUsers:a},{silent:!0});this.reset();if(0!==a.length){if(1===a.length){var a=a[0],b=a.get("id")===userId,e="root"===pathModel.get("organIds"),c=!0,d=!0,g=!0,f=a.get("isActive")&&!a.get("isAdmin"),h=a.get("isAdmin"),i=!a.get("isActive");b&&(i=h=f=g=!1);e&&!isDomainAdmin&&(f=h=!1,a.get("isAdmin")&&!b&&(i=g=d=c=!1));!isDomainAdmin&&a.get("isDomainAdmin")&&
(i=f=h=g=d=c=!1);a.get("isActive")||(d=c=!1);this.set({edit:c,move:d,del:g,setadmin:f,canceladmin:h,resend:i})}else{d=!0;b=0;for(e=a.length;b<e;b++)if(!a[b].get("isActive")){d=!1;break}this.set({move:d})}this.trigger("change")}},reset:function(){this.set({edit:!1,move:!1,del:!1,setadmin:!1,canceladmin:!1,resend:!1},{silent:!0})}});Sbox.Models.Menu=Backbone.Model.extend({defaults:{add:!0,edit:!0,del:!0}});
Sbox.Collections.UserList=Backbone.Collection.extend({model:Sbox.Models.User,initialize:function(){this.url=-1!==rootDepartmentInfo.power?"/User!getUsersByOrgan.action":"/User!getUsersByOrganLimit.action"},fetch:function(a){var b=this;a.organId="root"===a.organId?rootDepartmentInfo.id:a.organId;$.get(this.url,a,function(e){if(("root"===pathModel.getOrganId()?rootDepartmentInfo.id:pathModel.getOrganId())===a.organId)OrganizePageView.resetTotal(e.allCount),b.reset(e.result)},"json")},getChecked:function(){var a=
[];this.each(function(b){b.get("checked")&&a.push(b)});return a},checkAll:function(){this.each(function(a){a.isNew()||a.set({checked:!0})})},uncheckAll:function(){this.each(function(a){a.isNew()||a.set({checked:!1})})},checkById:function(a){this.get(a).set({checked:!0})},uncheckById:function(a){this.get(a).set({checked:!1})},toggelCheckById:function(a){this.get(a).get("checked")?this.uncheckById(a):this.checkById(a)},getIndexOfById:function(a){a=this.get(a);return this.indexOf(a)},getDomainAdmin:function(){var a=
null;this.each(function(b){b.get("isDomainAdmin")&&(a=b)});return a},getUserById:function(a){return this.get(a)},getUserByEmail:function(a){var b=null;this.each(function(e){e.get("email")===a&&(b=e)});return b},addUser:function(){}});
Sbox.Controllers.Router=Backbone.Router.extend({routes:{},initialize:function(){function a(){var a=$(window).height(),b=$("#header").height();d.attr("style","min-height:"+(a-b)+"px;*height:"+(a-b)+"px;")}rootDepartmentInfo.name=""===rootDepartmentInfo.name?"\u516c\u53f8":rootDepartmentInfo.name;var b=new Sbox.Collections.UserList;window.userListCollection=b;var e=new Sbox.Models.Path({path:rootDepartmentInfo.name,organIds:"root"});window.pathModel=e;var c=new Sbox.Views.OrganizeSidebar({userList:b,
path:e});$("#organizeView").append(c.el);b=new Sbox.Views.OrganizeMain({userList:b,path:e});$("#organizeView").append(b.el);organizeStatModel.set({all:rootDepartmentInfo.allUsers,used:rootDepartmentInfo.usedUsers});organizeUsageModel.set({all:rootDepartmentInfo.allSpace,used:rootDepartmentInfo.usedSpace});e.trigger("change");var d=$("#organizeView");d.find(".organize-tree");a();$(window).on("resize",a)}});
Sbox.Views.OrganizeStat=Backbone.View.extend({className:"organize-stat",template:_.template($("#statTemplate").html()),initialize:function(){this.userList=this.options.userList;this.path=this.options.path;this.model=window.organizeStatModel;_.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});
Sbox.Views.OrganizePath=Backbone.View.extend({className:"organize-nav",template:_.template($("#pathTemplate").html()),events:{"click a":"gopath"},initialize:function(){this.userList=this.options.userList;this.model=this.options.path;_.bindAll(this,"render");this.model.bind("change",this.render);this.model.bind("fresh",this.render)},render:function(){var a=this.model.get("path"),a=a.split("/");organIds=this.model.get("organIds").split("/");this.path=a;this.organIds=organIds;this.$el.html(this.template({paths:a}));
return this},gopath:function(a){var b=parseInt($(a.currentTarget).attr("data-index"));a.preventDefault();this.path=this.path.slice(0,b+1);this.organIds=this.organIds.slice(0,b+1);this.model.set({path:this.path.join("/"),organIds:this.organIds.join("/")})}});
Sbox.Views.OrganizeUsage=Backbone.View.extend({className:"organize-usage",template:_.template($("#usageTemplate").html()),initialize:function(){this.userList=this.options.userList;this.path=this.options.path;this.model=window.organizeUsageModel;_.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this}});
Sbox.Views.OrganizeAddUser=Backbone.View.extend({className:"organize-adduser",template:_.template($("#addUserTemplate").html()),events:{"click .adduser":"adduser","click .importuser":"importuser"},initialize:function(){this.userList=this.options.userList;this.path=this.options.path;_.bindAll(this,"render","updateBtn");organizeStatModel.bind("change",this.updateBtn)},render:function(){this.$el.html(this.template());this.$el.find(".importuser").remove();return this},updateBtn:function(){organizeStatModel.get("used")===
organizeStatModel.get("all")?this.$el.find(".adduser").attr("title","\u7528\u6237\u540d\u989d\u4e0d\u8db3").addClass("btn32-disabled"):this.$el.find(".adduser").attr("title","").removeClass("btn32-disabled")},adduser:function(){this.$el.find(".adduser").hasClass("btn32-disabled")||Sbox.CreateUser(this.userList,this.path)},importuser:function(){alert("\u5bfc\u5165\u7528\u6237")}});
Sbox.Views.OrganizeToolBar=Backbone.View.extend({className:"organize-toolbar",template:_.template($("#toolbarTemplate").html()),events:{"click .edit":"edit","click .move":"move","click .del":"del","click .setadmin":"setadmin","click .canceladmin":"canceladmin","click .resend":"resend"},initialize:function(){this.userList=this.options.userList;this.path=this.options.path;this.model=new Sbox.Models.ToolBar;_.bindAll(this,"render","select");this.model.bind("change",this.render);this.userList.bind("change",
this.select);this.userList.bind("reset",this.select);this.userList.bind("remove",this.select)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},select:function(){var a=this.userList.getChecked();0===a.length||isCloudVersion?this.$el.hide():this.$el.show();this.model.setSelectedUsers(a)},edit:function(){var a=this.userList.getChecked()[0];Sbox.EditUser(a,this.userList,this.path)},move:function(){var a=this.userList.getChecked();Sbox.MoveUser(a,this.userList,this.path)},
del:function(){var a=this.userList.getChecked()[0];Sbox.DeleteUser(a,this.userList)},setadmin:function(){var a=this.userList.getChecked()[0];Sbox.SetAdmin(a)},canceladmin:function(){var a=this.userList.getChecked()[0];Sbox.CancelAdmin(a)},resend:function(){var a=this.userList.getChecked()[0];Sbox.Resend(a)}});
Sbox.Views.OrganizeListHead=Backbone.View.extend({className:"ulist-head",template:_.template($("#ulistHeadTemplate").html()),events:{"click .checkbox":"checkAll"},initialize:function(){this.userList=this.options.userList;this.path=this.options.path;_.bindAll(this,"render","toggleChecked");this.userList.bind("change",this.toggleChecked);this.userList.bind("reset",this.toggleChecked)},render:function(){this.$el.html(this.template());return this},toggleChecked:function(){var a=this.userList.getChecked();
0===this.userList.length||a.length!==this.userList.length?this.$el.find(".checkbox").removeClass("icon-checked").addClass("icon-unchecked"):this.$el.find(".checkbox").removeClass("icon-unchecked").addClass("icon-checked")},checkAll:function(a){$(a.currentTarget).hasClass("icon-unchecked")?this.userList.checkAll():this.userList.uncheckAll()}});
Sbox.Views.OrganizeUserList=Backbone.View.extend({className:"ulist-body",template:_.template('<ul class="ulist"></ul>'),events:{"mouseenter li.uitem":"hover","mouseleave li.uitem":"leave","click li.uitem":"check"},initialize:function(){this.currentElement=null;this.userList=this.options.userList;this.path=this.options.path;this.organIds=this.path.get("organIds");_.bindAll(this,"render","addOne","addAll","refresh","remove","resetPager","loading");this.$el.on("selectstart",function(){return!1});this.userList.bind("add",
this.addOne);this.userList.bind("reset",this.addAll);this.userList.bind("reset",this.resetPager);this.userList.bind("remove",this.remove);this.userList.bind("loading",this.loading);this.userList.bind("refresh",this.refresh);this.path.bind("change",this.refresh)},render:function(){this.$el.html(this.template());return this},loading:function(){this.$(".ulist").html('<li class="empty-list"><span class="icon icon-loading"></span> \u6b63\u5728\u52a0\u8f7d...</li>')},addOne:function(a){var b=OrganizePageView.model;
b.get("total")>b.get("pagesize")&&OrganizePageView.resetTotal(b.get("total")+1);organizeUsageModel.set({used:organizeUsageModel.get("used")+a.get("settingSize")});organizeStatModel.set({used:organizeStatModel.get("used")+1});var e=new Sbox.Views.OrganizeUser({model:a,userList:this.userList,path:this.path});this.$(".ulist").find(".empty-list").remove();this.$(".ulist").prepend(e.render().el);e.$el.addClass("new");setTimeout(function(){e.$el.removeClass("new")},3E3)},addAll:function(){var a=this;this.currentElement=
null;0<this.userList.length?(this.$(".ulist").empty(),this.userList.each(function(b){b=new Sbox.Views.OrganizeUser({model:b,userList:a.userList,path:a.path});a.$(".ulist").append(b.render().el)})):(this.$(".ulist").empty(),this.$(".ulist").html('<li class="empty-list">\u8be5\u90e8\u95e8\u4e0b\u8fd8\u6ca1\u6709\u7528\u6237</li>'))},remove:function(a){this.$el.find("#user-"+a.get("id")).remove();a=OrganizePageView.model;OrganizePageView.resetTotal(a.get("total")-1);0===this.userList.length&&(a.get("total")<
a.get("pagesize")?(this.$(".ulist").empty(),this.$(".ulist").html('<li class="empty-list">\u8be5\u90e8\u95e8\u4e0b\u8fd8\u6ca1\u6709\u7528\u6237</li>')):this.userList.trigger("refresh"))},refresh:function(){var a=this.userList;this.$(".ulist").html('<li class="empty-list"><span class="icon icon-loading"></span> \u6b63\u5728\u52a0\u8f7d...</li>');OrganizePageView.resetTotal(0);a.fetch({organId:this.path.get("organIds").split("/").reverse()[0],start:0,length:10,_t:Math.random()})},resetPager:function(){this.organIds!==
this.path.get("organIds")&&(OrganizePageView.resetCurpage(1),this.organIds=this.path.get("organIds"))},hover:function(a){$(a.currentTarget).addClass("hover")},leave:function(a){$(a.currentTarget).removeClass("hover")},check:function(a){var b=$(a.currentTarget),e=b.attr("data-id"),c=this.userList,d=c.get(e);this.$el.find(".uitem");if(d&&-1!==rootDepartmentInfo.power&&(e=a.target||a.srcTarget,!$(e).hasClass("icon-checked")&&!$(e).hasClass("icon-unchecked"))){if(!a.ctrlKey&&!a.shiftKey||null===this.currentElement)this.currentElement=
b,!a.ctrlKey&&!a.shiftKey&&(d.get("checked")&&1===c.getChecked().length?setTimeout(function(){d.set({checked:!1})},30):setTimeout(function(){c.uncheckAll();d.set({checked:!0})},30));a.ctrlKey&&d.set({checked:!d.get("checked")});if(a.shiftKey){var g=c.getIndexOfById(this.currentElement.attr("data-id")),f=c.getIndexOfById(b.attr("data-id"));g>f&&(g+=f,f=g-f,g-=f);c.each(function(a,b){b>=g&&b<=f?c.at(b).set({checked:true}):c.at(b).set({checked:false})})}}}});
Sbox.Views.OrganizeUser=Backbone.View.extend({tagName:"li",className:"uitem",template:_.template($("#uItemTemplate").html()),events:{"click .checkbox":"check"},initialize:function(){this.userList=this.options.userList;this.path=this.options.path;_.bindAll(this,"render","check","setAdminBegin","setAdminEnd","cancelAdminBegin","cancelAdminEnd","resendBegin","resendEnd","editBegin","editEnd");this.model.bind("change",this.render);this.model.bind("setadmin.begin",this.setAdminBegin);this.model.bind("setadmin.end",
this.setAdminEnd);this.model.bind("canceladmin.begin",this.cancelAdminBegin);this.model.bind("canceladmin.end",this.cancelAdminEnd);this.model.bind("resend.begin",this.resendBegin);this.model.bind("resend.end",this.resendEnd);this.model.bind("edit.begin",this.editBegin);this.model.bind("edit.end",this.editEnd)},render:function(){this.$el.html(this.template(this.model.toJSON()));this.$el.attr("data-id",this.model.id);this.$el.attr("id","user-"+this.model.id);this.model.get("checked")?this.$el.addClass("selected"):
this.$el.removeClass("selected");return this},check:function(a){$(a.currentTarget).hasClass("icon-unchecked")?this.model.set({checked:!0}):this.model.set({checked:!1});a.stopImmediatePropagation()},setAdminBegin:function(){this.loading=Sbox.Loading("\u6b63\u5728\u8bbe\u7f6e\u8bf7\u7a0d\u5019...")},setAdminEnd:function(a){this.loading.remove();200===a.code?(Sbox.Success("\u5df2\u8bbe\u7f6e\u4e3a\u90e8\u95e8\u7ba1\u7406\u5458"),this.model.set({isAdmin:!0})):Sbox.Fail("\u8bbe\u7f6e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")},
cancelAdminBegin:function(){this.loading=Sbox.Loading("\u6b63\u5728\u53d6\u6d88\u8bf7\u7a0d\u5019...")},cancelAdminEnd:function(a){this.loading.remove();200===a.code?(Sbox.Success("\u5df2\u53d6\u6d88\u90e8\u95e8\u7ba1\u7406\u5458"),this.model.set({isAdmin:!1})):Sbox.Fail("\u53d6\u6d88\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")},editBegin:function(){},editEnd:function(){},resendBegin:function(){this.loading=Sbox.Loading("\u6b63\u5728\u91cd\u53d1\u8bf7\u7a0d\u5019...")},resendEnd:function(a){this.loading.remove();
200===a.code?Sbox.Success("\u90ae\u4ef6\u5df2\u91cd\u53d1\uff0c\u8bf7\u67e5\u6536"):Sbox.Fail("\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}});Sbox.Views.OrganizePage=Sbox.Views.Pager.extend({});
Sbox.Views.OrganizeSidebar=Backbone.View.extend({className:"organize-side",initialize:function(){this.userList=this.options.userList;this.path=this.options.path;this.render()},render:function(){var a=new Sbox.Views.DepartmentActions({userList:this.userList,path:this.path}),b=window.OrganizeTreeView=new Sbox.Views.OrganizeTree({userList:this.userList,path:this.path});this.$el.append(a.render().el).append(b.el)}});
Sbox.Views.OrganizeMain=Backbone.View.extend({className:"organize-main",initialize:function(){this.userList=this.options.userList;this.path=this.options.path;this.render()},render:function(){var a=new Sbox.Views.OrganizePath({userList:this.userList,path:this.path}),b=new Sbox.Views.OrganizeAddUser({userList:this.userList,path:this.path}),e=new Sbox.Views.OrganizeStat({userList:this.userList,path:this.path}),c=new Sbox.Views.OrganizeUserManage({userList:this.userList,path:this.path});this.$el.append(a.render().el).append(e.render().el).append(b.render().el).append(c.render().el);
return this}});
Sbox.Views.OrganizeUserManage=Backbone.View.extend({className:"organize-users",initialize:function(){this.userList=this.options.userList;this.path=this.options.path},render:function(){var a=this,b=new Sbox.Views.OrganizeToolBar({userList:this.userList,path:this.path}),e=new Sbox.Views.OrganizeListHead({userList:this.userList,path:this.path}),c=new Sbox.Views.OrganizeUserList({userList:this.userList,path:this.path}),d=new Sbox.Views.OrganizePage({userList:this.userList,path:this.path,total:10,pagesize:10,
callback:function(b){a.userList.trigger("loading");a.userList.fetch({organId:a.path.get("organIds").split("/").reverse()[0],start:(b.get("curpage")-1)*b.get("pagesize"),length:b.get("pagesize"),_t:Math.random()})}});window.OrganizePageView=d;this.$el.append(b.render().el).append(e.render().el).append(c.render().el).append(d.render().el);return this}});
Sbox.Views.DepartmentActions=Backbone.View.extend({className:"department-actions",template:_.template($("#departmentActionsTemplate").html()),events:{"click .add-department":"addDepartment","click .edit-department":"editDepartment","click .del-department":"delDepartment"},initialize:function(){_.bindAll(this,"render");this.path=this.options.path;this.path.bind("change",this.render)},render:function(){this.$el.html(this.template({isRoot:this.path.getOrganId()}));return this},addDepartment:function(){Sbox.CreateDepartment(this.path)},
editDepartment:function(a){$(a.currentTarget).hasClass("btn-disabled")||Sbox.EditDepartment(this.path)},delDepartment:function(a){$(a.currentTarget).hasClass("btn-disabled")||Sbox.DeleteDepartment(this.path.getOrganId())}});
Sbox.Views.OrganizeTree=Backbone.View.extend({className:"organize-tree",initialize:function(){var a=this;this.$el.append('<div class="folds cur" allSpace="'+rootDepartmentInfo.allSpace+'" usedSpace="'+rootDepartmentInfo.usedSpace+'"><i class="fold open"></i><a href="javascript:;" title="'+rootDepartmentInfo.name+'">'+rootDepartmentInfo.name+"</a></div>");var b=$('<ul id="organizeTree" class="ztree"></ul>').appendTo(this.$el);b.append('<li style="padding:20px;text-align:center;" class="tree-loading"><span class="icon icon-loading"></span></li>');
var e;e=-1!==rootDepartmentInfo.power?"/OrganManage!getOrgans.action?_t="+Math.random():"/OrganManage!getAllOrgans.action?_t="+Math.random();this.tree=$.fn.zTree.init(b,{view:{autoCancelSelected:!1,dblClickExpand:!1,expandSpeed:"fast",nameIsHTML:!1,selectedMulti:!1,showIcon:!0,showLine:!1,showTitle:!0},data:{keep:{leaf:!1,parent:!1}},async:{autoParam:["id"],dataFilter:function(a,b,e){a=[];return a=e.result},enable:!0,url:e},callback:{onClick:function(b,e,g){a.setPath(g);a.$el.find(".folds").removeClass("cur")},
onAsyncSuccess:function(){b.find("li.tree-loading").remove()},onExpand:function(){}}});this.path=this.options.path;_.bindAll(this,"render");this.path.bind("change",this.render);this.path.bind("reload.usage",this.render);this.$el.find(".folds").on("click",".fold",function(){var a=$(this);a.hasClass("open")?(a.removeClass("open").addClass("close"),b.slideUp("fast")):(a.removeClass("close").addClass("open"),b.slideDown("fast"))}).on("click","a",function(){a.path.set({path:rootDepartmentInfo.name,organIds:"root"})})},
render:function(){var a=this.path.get("organIds").split("/").reverse()[0];if("root"!==a){var b=this.tree.getSelectedNodes()[0],e=this.tree.getNodesByParam("id",a,null)[0];organizeUsageModel.set({all:e.all_space,used:e.all_space-e.space});b&&b.id===a||this.tree.selectNode(e,!1)}else organizeUsageModel.set({all:1*this.$el.find(".folds").attr("allSpace"),used:1*this.$el.find(".folds").attr("usedSpace")}),this.tree.cancelSelectedNode(this.tree.getSelectedNodes()[0]),this.$el.find(".folds").addClass("cur")},
setPath:function(a){for(var b=[],e=[];a;)b.push(a.name),e.push(a.id),a=a.getParentNode();b=0===b.length?rootDepartmentInfo.name:rootDepartmentInfo.name+"/"+b.reverse().join("/");e=0===e.length?"root":"root/"+e.reverse().join("/");this.path.set({path:b,organIds:e});return b}});
Sbox.Views.OrganizeMenu=Backbone.View.extend({className:"organize-menu",template:_.template($("#menuTemplate").html()),events:{"click .arrow":"showMenu","click .add-department":"addDepartment","click .edit-department":"editDepartment","click .del-department":"delDepartment"},initialize:function(){this.model=window.organizeMenuModel=new Sbox.Models.Menu;_.bindAll(this,"render");this.model.bind("change",this.render)},render:function(){this.$el.html(this.template(this.model.toJSON()));return this},showMenu:function(){var a=
this.$el.find("ul");a.is(":visible")?a.hide():a.show();this.$el.find("ul").on("mouseleave",function(){$(this).hide()})},addDepartment:function(){Sbox.CreateDepartment(this.model.get("organId"))},editDepartment:function(){Sbox.EditDepartment(this.model.get("organId"))},delDepartment:function(){Sbox.DeleteDepartment(this.model.get("organId"))}});$(document).ready(function(){new Sbox.Controllers.Router});
(function(a){Sbox.CreateDepartment=function(b){var e=b.get("organIds").split("/"),b=b.get("path").split("/"),e=e.pop(),b=b.join(" > "),c=null;OrganizeTreeView.$el.find(".folds");"root"!==e&&(c=OrganizeTreeView.tree.getNodesByParam("id",e,null)[0]);var d=new Sbox.Views.Window({title:"\u65b0\u5efa\u5b50\u90e8\u95e8",body:'<div class="organize-dialog create-department-dialog"> \t        \t\t<div class="field name"> \t        \t\t\t<div class="label">\u90e8\u95e8\u540d\u79f0\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="name" id="departmentName" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field change-department"> \t        \t\t\t<div class="label">\u4e0a\u7ea7\u90e8\u95e8\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<span id="parentDepartment">'+
b+'</span> <a id="changeDepartment" href="javascript:;">\u4fee\u6539</a> \t        \t\t\t\t<input type="hidden" name="parentId" id="parentDepartmentId" value="'+e+'" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t\t\t\t</div>',width:500,closeButton:!0,onClose:function(){d.remove()}}),e=d.body,g=e.find("#departmentName"),f=e.find("#parentDepartment"),h=e.find("#parentDepartmentId"),e=e.find("#changeDepartment"),i=!0;d.addButton({text:"\u786e\u5b9a",
className:"confirm",onclick:function(){i=!0;g.trigger("blur");var b=a.trim(g.val()),e="root"===h.val()?rootDepartmentInfo.id:h.val();i&&(Sbox.Loading("\u6b63\u5728\u521b\u5efa..."),d.hide(),a.post("/OrganManage!createOrgan.action",{name:b,parent:e},function(a){Sbox.Loading().remove();200===a.code?(Sbox.Success("\u521b\u5efa\u6210\u529f"),c?(c.isParent=!0,c.zAsync?(a=a.result,OrganizeTreeView.tree.addNodes(c,a,!1)):OrganizeTreeView.tree.reAsyncChildNodes(c,"refresh",!1)):(a=a.result,OrganizeTreeView.tree.addNodes(c,
a,!1))):303===a.code?(d.show(),g.parent().next().html('<span class="error">\u8be5\u90e8\u95e8\u5df2\u5b58\u5728</span>')):504===a.code?(d.show(),g.parent().next().html('<span class="error">\u540d\u5b57\u4e0d\u5408\u6cd5</span>')):(d.remove(),Sbox.Fail("\u521b\u5efa\u5931\u8d25"))},"json"))}}).addButton({text:"\u53d6\u6d88",className:"cancle",onclick:function(){d.remove()}});g.on("blur",function(){var b=a.trim(a(this).val());""===b?(a(this).parent().next().html('<span class="error">\u8bf7\u586b\u5199\u90e8\u95e8\u540d\u79f0</span>'),
i=!1):20<b.length?(a(this).parent().next().html('<span class="error">\u4e0d\u80fd\u8d85\u8fc720\u4e2a\u5b57\u7b26</span>'),i=!1):a(this).parent().next().empty()}).on("focus",function(){a(this).parent().next().empty()});e.on("click",function(){d.hide();Sbox.ChangeDepartment({callback:function(a){d.show();null!==a&&(f.html(a.path),h.val(a.id),c="root"===a.id?null:OrganizeTreeView.tree.getNodesByParam("id",a.id,null)[0])}})});return d};Sbox.EditDepartment=function(b){var e=b.get("organIds").split("/"),
c=b.get("path").split("/"),d=e.pop(),g=e.pop(),e=c.pop(),c=c.join(" > "),f=OrganizeTreeView.tree.getNodesByParam("id",d,null)[0];f.getParentNode();OrganizeTreeView.$el.find(".folds");var h=new Sbox.Views.Window({title:"\u7f16\u8f91\u90e8\u95e8",body:'<div class="organize-dialog edit-department-dialog"> \t        \t\t<div class="field name"> \t        \t\t\t<div class="label">\u90e8\u95e8\u540d\u79f0\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="name" value="'+
e+'" id="departmentName" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field change-department"> \t        \t\t\t<div class="label">\u4e0a\u7ea7\u90e8\u95e8\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<span id="parentDepartment">'+c+'</span> <a id="changeDepartment" href="javascript:;">\u4fee\u6539</a> \t        \t\t\t\t<input type="hidden" name="parentId" id="parentDepartmentId" value="'+g+'" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field" style="padding:0; margin-top:-10px; display: none;" id="parentTips" > \t        \t\t\t<div class="label"></div> \t        \t\t\t<div class="tips" style="margin:0;"> \t        \t\t\t</div> \t        \t\t</div> \t\t\t\t</div>',
width:500,closeButton:!0,onClose:function(){h.remove()}}),c=h.body,i=c.find("#departmentName"),k=c.find("#parentDepartment"),j=c.find("#parentDepartmentId"),e=c.find("#changeDepartment"),l=c.find("#parentTips"),n=!0;h.addButton({text:"\u786e\u5b9a",className:"confirm",onclick:function(){n=!0;i.trigger("blur");var e=a.trim(i.val()),c="root"===j.val()?rootDepartmentInfo.id:j.val();if(n){var k=Sbox.Loading("\u6b63\u5728\u4fee\u6539...");h.hide();a.post("/OrganManage!updateOrgan.action",{organId:d,name:e,
parent:c},function(a){k.remove();if(200===a.code){Sbox.Success("\u4fee\u6539\u6210\u529f");h.remove();c=c===rootDepartmentInfo.id?"root":c;f.name=e;OrganizeTreeView.tree.updateNode(f);a=OrganizeTreeView.tree.getSelectedNodes()[0];if(g===c)a=b.get("path").split("/"),a.pop(),a.push(e),b.set({path:a.join("/")},{silent:!0}),b.trigger("fresh");else{if("root"===c){var m=OrganizeTreeView.tree.transformToArray(f);OrganizeTreeView.tree.addNodes(null,m[0],!0);OrganizeTreeView.tree.removeNode(f)}else{var j=
OrganizeTreeView.tree.getNodesByParam("id",c,null)[0];j&&(j.zAsync&&(m=OrganizeTreeView.tree.transformToArray(f),OrganizeTreeView.tree.addNodes(j,m[0],!0)),OrganizeTreeView.tree.removeNode(f))}a&&a.id===d&&(a=b.get("path").split("/"),a.pop(),m=b.get("organIds").split("/"),m.pop(),b.set({path:a.join("/"),organIds:m.join("/")}))}b.trigger("reload.usage")}else 303===a.code?(h.show(),i.parent().next().html('<span class="error">\u8be5\u90e8\u95e8\u5df2\u5b58\u5728</span>')):504===a.code?(h.show(),i.parent().next().html('<span class="error">\u90e8\u95e8\u540d\u4e0d\u5408\u6cd5</span>')):
305===a.code?(h.show(),l.find(".tips").html('<span class="error">\u4e0d\u80fd\u79fb\u52a8\u5230\u672c\u90e8\u95e8\u6216\u5176\u4e0b\u7ea7\u90e8\u95e8</span>'),l.show()):(h.remove(),Sbox.Fail("\u4fee\u6539\u5931\u8d25"))},"json")}}}).addButton({text:"\u53d6\u6d88",className:"cancle",onclick:function(){h.remove()}});i.on("blur",function(){var b=a.trim(a(this).val());""===b?(a(this).parent().next().html('<span class="error">\u8bf7\u586b\u5199\u90e8\u95e8\u540d\u79f0</span>'),n=!1):20<b.length?(a(this).parent().next().html('<span class="error">\u4e0d\u80fd\u8d85\u8fc720\u4e2a\u5b57\u7b26</span>'),
n=!1):a(this).parent().next().empty()}).on("focus",function(){a(this).parent().next().empty()});e.on("click",function(){h.hide();l.hide();Sbox.ChangeDepartment({callback:function(a){h.show();null!==a&&(k.html(a.path),j.val(a.id))}})});return h};Sbox.DeleteDepartment=function(b){var e=OrganizeTreeView.tree.getNodesByParam("id",b,null)[0],c=e.getParentNode()||null,d=OrganizeTreeView.tree.getSelectedNodes()[0],g=OrganizeTreeView.$el.find(".folds"),f=Sbox.Warning({title:"\u5220\u9664\u90e8\u95e8",message:"<p>\u60a8\u786e\u5b9a\u8981\u5220\u9664\u90e8\u95e8 "+
e.name+' \u5417\uff1f</p> \t\t\t\t\t<p class="tip">\u5220\u9664\u90e8\u95e8\u540e\uff0c\u8be5\u90e8\u95e8\u53ca\u5b50\u90e8\u95e8\u7528\u6237\u90fd\u5c06\u5f52\u5c5e\u5230 <strong>'+(null===c?rootDepartmentInfo.name:c.name)+"</strong>\uff01</p>",closeButton:!0,callback:function(h){if(h){var i=Sbox.Loading("\u6b63\u5728\u5220\u9664\u8bf7\u7a0d\u5019");f.remove();a.post("/OrganManage!deleteOrgan.action",{organId:b},function(a){i.remove();if(200===a.code){Sbox.Success("\u5220\u9664\u6210\u529f");if(d&&
d.id===b){a=pathModel.get("path").split("/");a.pop();var f=pathModel.get("organIds").split("/");f.pop();pathModel.set({path:a.join("/"),organIds:f.join("/")})}(d&&c&&d.id===c.id||!c&&g.hasClass("cur"))&&pathModel.trigger("change");OrganizeTreeView.tree.removeNode(e);pathModel.trigger("reload.usage")}else Sbox.Fail("\u5220\u9664\u5931\u8d25")},"json")}}}).addStyle("del-department-dialog");return f};Sbox.CreateUser=function(b,e){var c=rootDepartmentInfo.adminSettingSize-rootDepartmentInfo.adminUsedSpace,
d=e.get("path").split("/").join(" > "),g=e.get("organIds").split("/").reverse()[0],c=parseInt(100*(c/1024/1024/1024))/100,f=new Sbox.Views.Window({title:"\u6dfb\u52a0\u7528\u6237",body:'<form><div class="organize-dialog create-user-dialog"> \t        \t\t<div class="field"> \t        \t\t\t<div class="label"><em>*</em>\u5e10\u53f7\u90ae\u7bb1\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="email" id="email" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t\t<span class="tip">\u8bf7\u586b\u5199\u771f\u5b9e\u90ae\u7bb1</span> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field"> \t        \t\t\t<div class="label"><em>*</em>\u59d3\u540d\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="name" id="userName" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t\t<span class="tip">\u5efa\u8bae\u586b\u5199\u771f\u5b9e\u59d3\u540d</span> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field change-department"> \t        \t\t\t<div class="label"><em>*</em>\u6240\u5c5e\u90e8\u95e8\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<span id="parentDepartment">'+
d+'</span> <a id="changeDepartment" href="javascript:;">\u4fee\u6539</a> \t        \t\t\t\t<input type="hidden" name="parent" id="parentDepartmentId" value="'+g+'"/> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field space"> \t        \t\t\t<div class="label"><em>*</em>\u7a7a\u95f4\u5206\u914d\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="space" id="space" /> \t        \t\t\t\t<em>GB</em> \t        \t\t\t\t<span>\u8be5\u90e8\u95e8\u5269\u4f59\u53ef\u5206\u914d\u7a7a\u95f4\uff1a<span id="freeSpace">'+
c+' GB</span></span> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field"> \t        \t\t\t<div class="label">\u529e\u516c\u7535\u8bdd\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="phone" id="phone" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t\t<span class="tip">\u8bf7\u586b\u5199\u8054\u7cfb\u7535\u8bdd</span> \t        \t\t\t</div> \t        \t\t</div> \t\t\t\t</div></form>',
width:560,closeButton:!0,onClose:function(){f.remove()}}),d=f.body,h=d.find("#email"),i=d.find("#userName"),k=d.find("#phone"),j=d.find("#space");d.find("#freeSpace");var l=d.find("#parentDepartment"),n=d.find("#parentDepartmentId"),d=d.find("#changeDepartment"),o=!0;f.addButton({text:"\u786e\u5b9a",className:"confirm",onclick:function(){o=!0;a("#email,#userName,#space,#phone").trigger("blur");if(o){var c=Sbox.Loading("\u6b63\u5728\u6dfb\u52a0...");f.hide();var e=a.trim(i.val()),d=a.trim(h.val()),
m="root"===n.val()?rootDepartmentInfo.id:n.val(),r=Math.floor(1073741824*a.trim(j.val())),l=a.trim(k.val());a.post("/OrganManage!addUser.action",{name:e,email:d,parent:m,space:r,phone:l},function(a){c.remove();200===a.code?(f.remove(),Sbox.Success("\u6dfb\u52a0\u6210\u529f"),m=m===rootDepartmentInfo.id?"root":m,g===m&&(a.result.isDomainAdmin=0,a=new Sbox.Models.User(a.result),b.add(a)),rootDepartmentInfo.adminSettingSize-=r,(a=b.getDomainAdmin())&&a.set({settingSize:rootDepartmentInfo.adminSettingSize}),
pathModel.trigger("reload.usage")):303===a.code?(f.show(),a=h.parent().next(),a.find(".tip").hide(),a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u8be5\u90ae\u7bb1\u5df2\u4f7f\u7528").show()):302===a.code?(f.show(),a=i.parent().next(),a.find(".tip").hide(),a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u8be5\u59d3\u540d\u5df2\u5b58\u5728").show()):501===a.code||503===a.code?(f.show(),a=j.parent().next(),a.find(".tip").hide(),
a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u7a7a\u95f4\u5206\u914d\u4e0d\u5408\u6cd5").show()):(f.remove(),Sbox.Fail("\u6dfb\u52a0\u5931\u8d25"))},"json")}}}).addButton({text:"\u53d6\u6d88",className:"cancle",onclick:function(){f.remove()}});a("#email,#userName,#space,#phone").each(function(b,e){function d(a){i.find(".tip").hide();i.find(".error")[0]||i.append('<span class="error"></span>');i.find(".error").text(a).show();o=!1}function h(){i.find(".tip").show();
i.find(".error").hide()}var g=a(e),k=g.attr("id"),i=g.parent().next();g.on("blur",function(){var b=a(this),b=a.trim(b.val());switch(k){case "email":""===b?d("\u90ae\u7bb1\u4e0d\u80fd\u4e3a\u7a7a"):mailReg.test(b)?h():d("\u90ae\u7bb1\u683c\u5f0f\u4e0d\u6b63\u786e");break;case "userName":""===b?d("\u59d3\u540d\u4e0d\u80fd\u4e3a\u7a7a"):10<b.length?d("\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc710\u4e2a\u5b57\u7b26"):nameReg.test(b)?h():d("\u652f\u6301\u4e2d\u82f1\u6587\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf");
break;case "space":a.isNumeric(b)?0>=1*b||0<b.indexOf(".")?d("\u5fc5\u987b\u662f\u5927\u4e8e0\u7684\u6574\u6570"):1*b>c?d("\u5269\u4f59\u7a7a\u95f4\u4e0d\u8db3"):h():d("\u8bf7\u8f93\u5165\u6570\u5b57");break;case "phone":""!==b&&!/(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})(\-[0-9]{1,4})?$)|(^(1[3458]\d{9})$)/.test(b)?d("\u7535\u8bdd\u683c\u5f0f\u4e0d\u6b63\u786e"):h()}}).on("focus",function(){h()}).on("keypress",function(a){13===a.keyCode&&f.getButton("\u786e\u5b9a")[0].trigger("click")})});d.on("click",
function(){f.hide();Sbox.ChangeDepartment({callback:function(a){f.show();null!==a&&(l.html(a.path),n.val(a.id))}})})};Sbox.EditUser=function(b,e,c){var d=rootDepartmentInfo.adminSettingSize,g=rootDepartmentInfo.adminUsedSpace,f=b.get("settingSize")+d-g,h=b.get("settingSize"),i=f;parentDepartmentPath=c.get("path").split("/").join(" > ");parentDepartmentId=c.get("organIds").split("/").reverse()[0];var f=parseInt(100*(f/1024/1024/1024))/100,k=new Sbox.Views.Window({title:"\u7f16\u8f91\u7528\u6237",body:'<form> \t\t\t\t\t<input type="hidden" name="userId" id="userId"  value="'+
b.get("id")+'" />\t\t\t\t\t<div class="organize-dialog create-user-dialog"> \t        \t\t<div class="field"> \t        \t\t\t<div class="label">\u5e10\u53f7\u90ae\u7bb1\uff1a</div> \t        \t\t\t<div class="ipt">'+b.get("email")+'</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field"> \t        \t\t\t<div class="label"><em>*</em>\u59d3\u540d\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="name" value="'+
b.get("nickName")+'" id="userName" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t\t<span class="tip">\u5efa\u8bae\u586b\u5199\u771f\u5b9e\u59d3\u540d</span> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field space"> \t        \t\t\t<div class="label">'+(b.get("isDomainAdmin")?"\u7a7a\u95f4\u5927\u5c0f\uff1a":"<em>*</em>\u7a7a\u95f4\u5206\u914d\uff1a")+'</div> \t        \t\t\t<div class="ipt">'+(b.get("isDomainAdmin")?parseInt(100*(rootDepartmentInfo.adminSettingSize/
1024/1024/1024))/100:'<input type="text" class="ipt-text" name="space" id="space" value="'+Math.round(100*(b.get("settingSize")/1024/1024/1024))/100+'" />')+'<em> GB</em> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field space" style="margin-top:-10px; '+(b.get("isDomainAdmin")?"display:none;":"")+'"> \t        \t\t\t<div class="label"></div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<span>\u8be5\u7528\u6237\u5df2\u4f7f\u7528\u7a7a\u95f4:<span id="usedSpace">'+
formatbytes(b.get("usedSize"))+'</span>\uff0c\u5269\u4f59\u53ef\u5206\u914d\u7a7a\u95f4\uff1a<span id="freeSpace">'+f+' GB</span></span> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t</div> \t        \t\t</div> \t        \t\t<div class="field"> \t        \t\t\t<div class="label">\u529e\u516c\u7535\u8bdd\uff1a</div> \t        \t\t\t<div class="ipt"> \t        \t\t\t\t<input type="text" class="ipt-text" name="phone" value="'+b.get("phoneNum")+'" id="phone" /> \t        \t\t\t</div> \t        \t\t\t<div class="tips"> \t        \t\t\t\t<span class="tip">\u8bf7\u586b\u5199\u8054\u7cfb\u7535\u8bdd</span> \t        \t\t\t</div> \t        \t\t</div> \t\t\t\t</div><form>',
width:560,closeButton:!0,onClose:function(){k.remove()}}),c=k.body,j=c.find("#userName"),l=c.find("#space"),n=c.find("#phone"),o=c.find("#freeSpace"),q=c.find("#parentDepartment"),p=c.find("#parentDepartmentId"),c=c.find("#changeDepartment");k.addButton({text:"\u786e\u5b9a",className:"confirm",onclick:function(){flag=!0;a("#userName,#space,#phone").trigger("blur");if(flag){var c=Sbox.Loading("\u6b63\u5728\u4fee\u6539");k.hide();var d=a.trim(j.val()),f="root"===p.val()?rootDepartmentInfo.id:p.val(),
g=b.get("isDomainAdmin")?rootDepartmentInfo.adminSettingSize:Math.floor(1073741824*a.trim(l.val())),i=a.trim(n.val());a.post("/OrganManage!updateUser.action",{userId:b.get("id"),name:d,parent:f,space:g,phone:i},function(a){c.remove();200===a.code?(k.remove(),Sbox.Success("\u4fee\u6539\u6210\u529f"),f=f===rootDepartmentInfo.id?"root":f,b.set({nickName:d,phoneNum:i,settingSize:g}),b.get("isDomainAdmin")||(rootDepartmentInfo.adminSettingSize-=g-h,(a=e.getDomainAdmin())&&a.set({settingSize:rootDepartmentInfo.adminSettingSize})),
pathModel.trigger("reload.usage")):302===a.code?(k.show(),a=j.parent().next(),a.find(".tip").hide(),a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u8be5\u59d3\u540d\u5df2\u5b58\u5728").show()):303===a.code?(k.show(),a=$email.parent().next(),a.find(".tip").hide(),a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u8be5\u90ae\u7bb1\u5df2\u4f7f\u7528").show()):501===a.code||503===a.code?(k.show(),a=l.parent().next(),a.find(".tip").hide(),
a.find(".error")[0]||a.append('<span class="error"></span>'),a.find(".error").text("\u7a7a\u95f4\u5206\u914d\u4e0d\u5408\u6cd5").show()):(k.remove(),Sbox.Fail("\u4fee\u6539\u5931\u8d25"))},"json")}}}).addButton({text:"\u53d6\u6d88",className:"cancle",onclick:function(){k.remove()}});a("#userName,#space,#phone").each(function(c,e){function d(a){j.find(".tip").hide();j.find(".error")[0]||j.append('<span class="error"></span>');j.find(".error").text(a).show();flag=!1}function h(){j.find(".tip").show();
j.find(".error").hide()}var g=a(e),i=g.attr("id"),j=g.parent().next();g.on("blur",function(){var c=a(this),c=a.trim(c.val());switch(i){case "userName":""===c?d("\u59d3\u540d\u4e0d\u80fd\u4e3a\u7a7a"):10<c.length?d("\u957f\u5ea6\u4e0d\u80fd\u8d85\u8fc710\u4e2a\u5b57\u7b26"):nameReg.test(c)?h():d("\u652f\u6301\u4e2d\u82f1\u6587\u3001\u6570\u5b57\u3001\u4e0b\u5212\u7ebf");break;case "space":a.isNumeric(c)?0>=1*c||0<c.indexOf(".")?d("\u5fc5\u987b\u662f\u5927\u4e8e0\u7684\u6574\u6570"):1*c>f?d("\u5269\u4f59\u7a7a\u95f4\u4e0d\u8db3"):
1073741824*c<b.get("usedSize")?d("\u5206\u914d\u7a7a\u95f4\u5c0f\u4e8e\u7528\u6237\u5df2\u4f7f\u7528\u7a7a\u95f4"):h():d("\u8bf7\u8f93\u5165\u6570\u5b57");break;case "phone":""!==c&&!/(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})(\-[0-9]{1,4})?$)|(^(1[3458]\d{9})$)/.test(c)?d("\u7535\u8bdd\u683c\u5f0f\u4e0d\u6b63\u786e"):h()}}).on("focus",function(){h()}).on("keypress",function(a){13===a.keyCode&&k.getButton("\u786e\u5b9a")[0].trigger("click")})});if(b.get("id")===userId&&!isDomainAdmin)c.remove();else c.on("click",
function(){k.hide();Sbox.ChangeDepartment({callback:function(a){null===a?k.show():(d=a.allSpace,g=a.usedSpace,b.get("isAdmin")&&a.id!==parentDepartmentId?Sbox.Warning({title:"\u4fee\u6539\u90e8\u95e8",message:'<p>\u60a8\u786e\u5b9a\u4fee\u6539\u7528\u6237\u6240\u5c5e\u90e8\u95e8\u5417\uff1f</p> \t                                    <p class="tip">\u4fee\u6539\u6240\u5c5e\u90e8\u95e8\u540e\u5c06\u53d6\u6d88\u8be5\u7528\u6237\u90e8\u95e8\u7ba1\u7406\u5458\u8eab\u4efd\uff01</p>',closeButton:!1,esc:!1,
callback:function(b){k.show();b?(f=d-g,f=parseInt(100*(f/1024/1024/1024))/100,o.html(f+" GB"),q.html(a.path),p.val(a.id)):(f=i,o.html(f+" GB"),q.html(parentDepartmentPath),p.val(parentDepartmentId))}}):(a.id===parentDepartmentId?(k.show(),f=b.get("settingSize")+d-g):(k.show(),f=d-g),f=parseInt(100*(f/1024/1024/1024))/100,o.html(f+" GB"),q.html(a.path),p.val(a.id)))}})})};Sbox.DeleteUser=function(b,e){var c=Sbox.Warning({title:"\u5220\u9664\u7528\u6237",message:"<p>\u60a8\u786e\u5b9a\u8981\u5220\u9664\u7528\u6237 "+
b.get("nickName")+' \u5417\uff1f</p> \t\t\t\t\t<p class="tip">\u8be5\u7528\u6237\u6240\u6709\u6587\u4ef6\u5bb9\u91cf'+formatbytes(b.get("usedSize"))+'</p> \t\t\t\t\t<div style="position:relative; left:-50px;  padding-top:10px;"> \t\t\t\t\t\t<p style="font-size:12px; margin:15px 0 5px 0;"> \t\t\t\t\t\t\t<input type="radio" checked="checked" name="deltype" value="1" id="toUser" /> \t\t\t\t\t\t\t<label for="toUser" style="vertical-align:middle; color:#999"> \u5220\u9664\u7528\u6237\uff0c\u628a\u6587\u4ef6\u8f6c\u79fb\u7ed9\u5176\u4ed6\u7528\u6237</label> \t\t\t\t\t\t</p> \t\t\t\t\t\t<p style="font-size:12px; margin:5px 0 10px 0;"> \t\t\t\t\t\t<input type="text" class="ipt-text" style="width:200px; margin-left:18px;" id="email" placeholder="\u8bf7\u8f93\u5165\u63a5\u53d7\u6587\u4ef6\u7684\u7528\u6237\u90ae\u7bb1" autocomplete="off" /> <span class="error" id="emailTip"></span> \t\t\t\t\t\t</p> \t\t\t\t\t\t<p style="font-size:12px;"> \t\t\t\t\t\t\t<input type="radio" name="deltype" value="0" id="delAll" /> \t\t\t\t\t\t\t<label for="delAll" style="vertical-align:middle; color:#999"> \u5f7b\u5e95\u5220\u9664\u7528\u6237\uff0c\u628a\u7528\u6237\u6240\u6709\u6587\u4ef6\u4e5f\u5220\u9664</label> \t\t\t\t\t\t</p> \t\t\t\t\t</div>',
closeButton:!0,preventHide:!0,callback:function(g){if(g){var i=d.find("input:radio:checked").val(),g=a.trim(f.val());if("1"===i){if(""===g){h.html("\u8bf7\u8f93\u5165\u90ae\u7bb1\u5730\u5740");return}if(!mailReg.test(g)){h.html("\u90ae\u7bb1\u5730\u5740\u4e0d\u6b63\u786e");return}}var l=Sbox.Loading("\u6b63\u5728\u5220\u9664\u8bf7\u7a0d\u5019");c.hide();a.post("/OrganManage!deleteOrganUser.action",{userId:b.get("id"),deleteWay:i,shiftEmail:"1"===i?a.trim(f.val()):""},function(d){l.remove();if(200===
d.code){c.remove();Sbox.Success("\u5220\u9664\u6210\u529f");organizeStatModel.set({used:organizeStatModel.get("used")-1});if("1"===i){var g=e.getUserByEmail(a.trim(f.val()));g&&g.set({usedSize:g.get("usedSize")+b.get("usedSize"),settingSize:g.get("settingSize")+b.get("settingSize")});rootDepartmentInfo.adminUsedSpace=d.spaceSituation.adminUsedSpace;rootDepartmentInfo.adminSettingSize=d.spaceSituation.adminAllSpace}else rootDepartmentInfo.adminSettingSize+=b.get("settingSize"),(d=e.getDomainAdmin())&&
d.set({settingSize:rootDepartmentInfo.adminSettingSize});e.remove(b);pathModel.trigger("reload.usage")}else 502===d.code?(c.show(),h.html("\u8f6c\u79fb\u7528\u6237\u7a7a\u95f4\u4e0d\u8db3")):405===d.code?(c.show(),h.html("\u8be5\u7528\u6237\u4e0d\u5b58\u5728")):407===d.code?(c.show(),h.html("\u8be5\u7528\u6237\u672a\u6fc0\u6d3b")):505===d.code?(c.show(),h.html("\u4e0d\u80fd\u8f6c\u79fb\u7ed9\u5220\u9664\u7528\u6237")):406===d.code?(c.remove(),Sbox.Fail("\u4e0d\u80fd\u5220\u9664\u57df\u7ba1\u7406\u5458",
2)):(c.remove(),Sbox.Fail("\u5220\u9664\u5931\u8d25"))},"json")}}}).addStyle("del-user-dialog"),d=c.body,g=d.find("#toUser"),f=d.find("#email"),h=d.find("#emailTip"),i=d.find("#delAll");!b.get("isActive")||0===b.get("usedSize")?(g.attr("disabled",!0),f.attr("disabled",!0),i.attr("checked",!0)):(Sbox.placeholder(f),Sbox.Util.selectUser(f),f.on("focus",function(){g.attr("checked",!0)}),g.on("click",function(){f.focus()}));i.on("click",function(){h.empty();f.blur()});return c};Sbox.MoveUser=function(b,
e,c){for(var d=[],g=c.get("organIds").split("/").reverse()[0],c=0,f=b.length;c<f;c++)d.push(b[c].get("id"));Sbox.ChangeDepartment({isMove:!0,callback:function(c){null!==c&&(g===c.id?Sbox.Fail("\u8be5\u7528\u6237\u5df2\u5728\u8be5\u90e8\u95e8\u4e0b"):(c=c.id,Sbox.Loading("\u6b63\u5728\u79fb\u52a8..."),c="root"===c?rootDepartmentInfo.id:c,a.post("/OrganManage!moveUsersToOrgan.action",{userIds:d.join(","),parent:c},function(a){Sbox.Loading().remove();200===a.code&&(Sbox.Success("\u79fb\u52a8\u6210\u529f"),
e.remove(b))},"json")))}})};Sbox.ChangeDepartment=function(b){var e=new Sbox.Views.Window({title:b.isMove?"\u79fb\u52a8\u5230":"\u4fee\u6539\u90e8\u95e8",body:'<div class="organize-tree change-department-tree"><div class="folds cur"><i class="fold open"></i><a href="javascript:;">'+rootDepartmentInfo.name+'</a></div><ul class="ztree" id="ChangeDepartmentTree"></ul></div>',width:370,closeButton:!0,onHide:function(){b.callback(null);e.remove()}}),c=e.body,d={id:"root"},g=c.find("#ChangeDepartmentTree");
g.append('<li style="padding:20px;text-align:center;" class="tree-loading"><span class="icon icon-loading"></span></li>');c.find(".folds").on("click",".fold",function(){var b=a(this);b.hasClass("open")?(b.removeClass("open").addClass("close"),g.slideUp("fast")):(b.removeClass("close").addClass("open"),g.slideDown("fast"))}).on("click","a",function(){f.cancelSelectedNode(f.getSelectedNodes()[0]);c.find(".folds").addClass("cur");d={id:"root"}});e.addButton({text:"\u786e\u5b9a",className:"confirm",onclick:function(){var a=
[rootDepartmentInfo.name],c=[],g,j;if("root"!==d.id){var l=f.getSelectedNodes()[0];g=1*l.all_space;for(j=1*l.all_space-1*l.space;l;)c.push(l.name),l=l.getParentNode()}else j=OrganizeTreeView.$el.find(".folds"),g=1*j.attr("allSpace"),j=1*j.attr("usedSpace");a=a.concat(c.reverse()).join(" > ");b.callback({path:a,allSpace:g,usedSpace:j,id:d.id});e.remove()}}).addButton({text:"\u53d6\u6d88",className:"cancle",onclick:function(){e.hide()}});var f=a.fn.zTree.init(g,{view:{autoCancelSelected:!1,dblClickExpand:!1,
expandSpeed:"fast",nameIsHTML:!0,selectedMulti:!1,showIcon:!0,showLine:!1,showTitle:!0},data:{keep:{leaf:!1,parent:!1}},async:{autoParam:["id"],dataFilter:function(a,b,c){return c.result},enable:!0,type:"get",url:"/OrganManage!getOrgans.action?_t="+(new Date).valueOf()},callback:{onClick:function(a,b,e){c.find(".folds").removeClass("cur");d=e},onAsyncSuccess:function(){g.find("li.tree-loading").remove()},onExpand:function(){}}});return e};Sbox.SetAdmin=function(a){a.setAdmin()};Sbox.CancelAdmin=function(a){a.cancelAdmin()};
Sbox.Resend=function(a){a.resend()};Sbox.ImportUser=function(){}})(jQuery);
